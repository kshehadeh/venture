{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/scene.schema.json",
  "title": "SceneDefinition",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "title", "narrative", "choices"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "description": "Unique identifier for the scene."
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "description": "Short label displayed in the UI."
    },
    "narrative": {
      "type": "string",
      "minLength": 1,
      "description": "Narrative text shown for the scene."
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1,
        "pattern": "^[a-zA-Z0-9_-]+$"
      },
      "uniqueItems": true,
      "description": "Optional tags for filtering or analytics."
    },
    "choices": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/choice"
      },
      "description": "Available actions from this scene."
    },
    "objects": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/objectDefinition"
      },
      "description": "Objects present in this scene."
    },
    "exits": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/exitDefinition"
      },
      "description": "Exits from this scene."
    },
    "npcs": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/npcDefinition"
      },
      "description": "Non-player characters in this scene."
    },
    "detailedDescriptions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/detailedDescription"
      },
      "description": "Detailed descriptions with perception thresholds for the scene."
    }
  },
  "definitions": {
    "statBlock": {
      "type": "object",
      "description": "Stat thresholds for requirements or deltas for effects.",
      "additionalProperties": false,
      "properties": {
        "health": { "type": "number" },
        "willpower": { "type": "number" },
        "perception": { "type": "number" },
        "reputation": { "type": "number" },
        "strength": { "type": "number" }
      }
    },
    "inventoryEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "quantity"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "quantity": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "stats": { "$ref": "#/definitions/statBlock" },
        "traits": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        },
        "flags": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        },
        "items": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        }
      },
      "description": "Checks that must pass before the choice is available."
    },
    "effects": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "stats": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "health": { "type": "number" },
            "willpower": { "type": "number" },
            "perception": { "type": "number" },
            "reputation": { "type": "number" },
            "strength": { "type": "number" }
          },
          "description": "Numeric deltas to apply to stats; use negatives to subtract."
        },
        "addTraits": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        },
        "removeTraits": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        },
        "addFlags": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        },
        "removeFlags": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true
        },
        "addItems": {
          "type": "array",
          "items": { "$ref": "#/definitions/inventoryEntry" },
          "uniqueItems": true
        },
        "removeItems": {
          "type": "array",
          "items": { "$ref": "#/definitions/inventoryEntry" },
          "uniqueItems": true
        },
        "hiddenConsequences": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true,
          "description": "Effects recorded for later resolution (e.g., foreshadowing)."
        }
      },
      "description": "State changes that occur after choosing this option."
    },
    "choice": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "text", "nextSceneId"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Unique within the scene."
        },
        "text": {
          "type": "string",
          "minLength": 1,
          "description": "Text shown to the player."
        },
        "requirements": { "$ref": "#/definitions/requirements" },
        "effects": { "$ref": "#/definitions/effects" },
        "nextSceneId": {
          "type": ["string", "null"],
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Scene to transition to; null indicates end or epilogue."
        }
      }
    },
    "objectDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "weight", "perception", "removable", "description", "traits"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Unique identifier for the object."
        },
        "quantity": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Quantity of the object (defaults to 1)."
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "description": "Weight of the object."
        },
        "perception": {
          "type": "number",
          "description": "Minimum perception required to notice this object."
        },
        "removable": {
          "type": "boolean",
          "description": "Whether this object can be picked up."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Full description of the object."
        },
        "traits": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true,
          "description": "Array of trait strings associated with the object."
        },
        "carryEffects": {
          "$ref": "#/definitions/effects",
          "description": "Effects applied when the object is picked up."
        },
        "viewEffects": {
          "$ref": "#/definitions/effects",
          "description": "Effects applied when the object is looked at."
        },
        "proximityEffect": {
          "$ref": "#/definitions/effects",
          "description": "Effects applied when the character is in the scene with this object."
        },
        "contains": {
          "type": "array",
          "items": { "$ref": "#/definitions/objectDefinition" },
          "description": "Nested objects if this is a container (general storage)."
        },
        "slots": {
          "type": "array",
          "items": { "$ref": "#/definitions/slotDefinition" },
          "description": "Named slots that can each hold exactly one item."
        },
        "maxWeight": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum weight capacity for containers."
        },
        "width": {
          "type": "number",
          "minimum": 0,
          "description": "Width dimension of the object."
        },
        "height": {
          "type": "number",
          "minimum": 0,
          "description": "Height dimension of the object."
        },
        "depth": {
          "type": "number",
          "minimum": 0,
          "description": "Depth dimension of the object."
        },
        "detailedDescriptions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/detailedDescription"
          },
          "description": "Detailed descriptions with perception thresholds for the object."
        }
      }
    },
    "slotDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Unique identifier within the container."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name for the slot (optional, defaults to id)."
        },
        "maxWeight": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum weight capacity for this slot."
        },
        "width": {
          "type": "number",
          "minimum": 0,
          "description": "Width dimension constraint for this slot."
        },
        "height": {
          "type": "number",
          "minimum": 0,
          "description": "Height dimension constraint for this slot."
        },
        "depth": {
          "type": "number",
          "minimum": 0,
          "description": "Depth dimension constraint for this slot."
        },
        "itemId": {
          "type": ["string", "null"],
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Currently assigned item ID (null if empty)."
        }
      }
    },
    "detailedDescription": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text", "perception"],
      "properties": {
        "text": {
          "type": "string",
          "minLength": 1,
          "description": "The detailed description text."
        },
        "perception": {
          "type": "number",
          "description": "Minimum perception required to see this detail."
        },
        "effects": {
          "$ref": "#/definitions/effects",
          "description": "Optional effects that apply when this detail is visible."
        }
      }
    },
    "exitDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["direction", "nextSceneId"],
      "properties": {
        "direction": {
          "type": "string",
          "enum": ["n", "s", "w", "e", "nw", "ne", "sw", "se"],
          "description": "Direction of the exit."
        },
        "type": {
          "type": "string",
          "description": "Type of exit (e.g., 'opening', 'door')."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Optional descriptive name for the exit."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Optional full description of the exit."
        },
        "nextSceneId": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "The scene to transition to."
        },
        "requirements": {
          "$ref": "#/definitions/requirements",
          "description": "Optional requirements to use this exit."
        },
        "perception": {
          "type": "number",
          "description": "Perception required to notice this exit (defaults to 0)."
        },
        "detailedDescriptions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/detailedDescription"
          },
          "description": "Detailed descriptions with perception thresholds for the exit."
        }
      }
    },
    "npcDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "baseStats"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Unique NPC ID."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Name of the NPC."
        },
        "baseStats": {
          "$ref": "#/definitions/statBlock",
          "description": "Base stats for the NPC."
        },
        "traits": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
          "uniqueItems": true,
          "description": "Optional traits for the NPC."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Optional description for display."
        },
        "detailedDescriptions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/detailedDescription"
          },
          "description": "Detailed descriptions with perception thresholds for the NPC."
        }
      }
    }
  }
}
